name: Nightly Build

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # 1. Standard Targets (Linux All-Arch & Win-x64)
  standard-build:
    runs-on: ubuntu-latest
    container:
      image: debian:trixie-slim
    steps:
      - uses: actions/checkout@v4
      - name: Install Toolchains
        run: |
          apt-get update && apt-get install -y build-essential make tar \
          gcc-aarch64-linux-gnu gcc-riscv64-linux-gnu \
          gcc-powerpc64le-linux-gnu gcc-mips64el-linux-gnuabi64 \
          gcc-mingw-w64-x86-64
      - name: Build
        run: |
          chmod +x scripts/cross_build_from_debian_13_x64.sh
          ./scripts/cross_build_from_debian_13_x64.sh --os-only linux
          ./scripts/cross_build_from_debian_13_x64.sh --os-only windows
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: standard-binaries
          path: dist/*.tar.gz

  # 2. Windows ARM64 (Manual Build)
  build-win-arm64:
    runs-on: ubuntu-latest
    container:
      image: dockcross/windows-arm64:latest
    steps:
      - uses: actions/checkout@v4
      - name: Build and Package
        run: |
          make clean
          # Clean override of performance flags for MinGW ARM64
          CC=aarch64-w64-mingw32-gcc AR=aarch64-w64-mingw32-ar \
          PERF_STACK_FLAGS="-O3 -pipe -flto -fomit-frame-pointer -DNDEBUG" \
          EXTRA_CFLAGS="-fPIC -D_WIN32_WINNT=0x0600 -D_GNU_SOURCE" make -j$(nproc)
          
          TAG="libttak-windows-arm64"
          mkdir -p "dist/${TAG}/include" "dist/${TAG}/lib"
          cp -r include/* "dist/${TAG}/include/"
          cp lib/libttak.a "dist/${TAG}/lib/"
          cd dist && tar -czf "${TAG}.tar.gz" "${TAG}"
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: win-arm64-binary
          path: dist/*.tar.gz

  # 3. macOS (Native Build)
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - uses: actions/checkout@v4
      - name: Build and Package
        run: |
          make clean
          # Remove GCC-specific '-ffat-lto-objects' and '-march=native' which fail on Clang
          CC=clang AR=ar \
          PERF_STACK_FLAGS="-O3 -pipe -flto -fomit-frame-pointer -DNDEBUG" \
          EXTRA_CFLAGS="-arch ${{ matrix.arch }} -fPIC -D_DARWIN_C_SOURCE" make -j$(sysctl -n hw.ncpu)
          
          TAG="libttak-darwin-${{ matrix.arch }}"
          mkdir -p "dist/${TAG}/include" "dist/${TAG}/lib"
          cp -r include/* "dist/${TAG}/include/"
          cp lib/libttak.a "dist/${TAG}/lib/"
          cd dist && tar -czf "${TAG}.tar.gz" "${TAG}"
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-binary
          path: dist/*.tar.gz

  # 4. BSD Family (Native Build via VM)
  build-bsd:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [freebsd, openbsd, netbsd]
    steps:
      - uses: actions/checkout@v4
      - name: Build in VM
        uses: cross-platform-actions/action@v0.25.0
        with:
          operating_system: ${{ matrix.os }}
          run: |
            if [ "${{ matrix.os }}" = "freebsd" ]; then
              sudo pkg install -y gmake gcc
              MAKE_CMD=gmake
            elif [ "${{ matrix.os }}" = "openbsd" ]; then
              sudo pkg_add gmake gcc
              MAKE_CMD=gmake
            else
              sudo pkgin install -y gmake gcc
              MAKE_CMD=gmake
            fi
            
            $MAKE_CMD clean
            # Use safe performance flags that work across different GCC versions on BSD
            CC=gcc AR=ar \
            PERF_STACK_FLAGS="-O3 -pipe -fomit-frame-pointer -DNDEBUG" \
            EXTRA_CFLAGS="-fPIC -D__BSD_VISIBLE=1" $MAKE_CMD -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)
            
            TAG="libttak-${{ matrix.os }}-amd64"
            mkdir -p "dist/${TAG}/include" "dist/${TAG}/lib"
            cp -r include/* "dist/${TAG}/include/"
            cp lib/libttak.a "dist/${TAG}/lib/"
            cd dist && tar -czf "${TAG}.tar.gz" "${TAG}"
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-binary
          path: dist/*.tar.gz

  # 5. Global Release
  release:
    needs: [standard-build, build-win-arm64, build-macos, build-bsd]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: nightly-${{ github.run_id }}
          name: LibTTAK Nightly Build
          files: dist/*.tar.gz
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
