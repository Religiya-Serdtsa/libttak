name: Nightly Build

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # 1. Standard Targets (Linux All-Arch & Win-x64)
  standard-build:
    runs-on: ubuntu-latest
    container:
      image: debian:trixie-slim
    steps:
      - uses: actions/checkout@v4
      - name: Install Toolchains
        run: |
          apt-get update && apt-get install -y build-essential make tar \
          gcc-aarch64-linux-gnu gcc-riscv64-linux-gnu \
          gcc-powerpc64le-linux-gnu gcc-mips64el-linux-gnuabi64 \
          gcc-mingw-w64-x86-64
      - name: Build Standard Targets
        run: |
          chmod +x scripts/cross_build_from_debian_13_x64.sh
          ./scripts/cross_build_from_debian_13_x64.sh --os-only linux
          ./scripts/cross_build_from_debian_13_x64.sh --os-only windows
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: standard-binaries
          path: dist/*.tar.gz

  # 2. Windows ARM64 (Manual Build)
  build-win-arm64:
    runs-on: ubuntu-latest
    container:
      image: dockcross/windows-arm64:latest
    steps:
      - uses: actions/checkout@v4
      - name: Manual Build and Package
        run: |
          make clean
          CC=aarch64-w64-mingw32-gcc AR=aarch64-w64-mingw32-ar \
          PERF_STACK_FLAGS="-O3 -pipe -flto -fomit-frame-pointer -DNDEBUG" \
          EXTRA_CFLAGS="-fPIC -D_WIN32_WINNT=0x0600 -D_GNU_SOURCE" make -j$(nproc)

          TAG="libttak-windows-arm64"
          mkdir -p "dist/${TAG}/include" "dist/${TAG}/lib"
          cp -r include/* "dist/${TAG}/include/"
          cp lib/libttak.a "dist/${TAG}/lib/"
          cd dist && tar -czf "${TAG}.tar.gz" "${TAG}"
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: win-arm64-binary
          path: dist/*.tar.gz

  # 3. macOS (Native Build)
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - uses: actions/checkout@v4
      - name: Manual Build and Package
        run: |
          make clean
          CC=clang AR=ar \
          PERF_STACK_FLAGS="-O3 -pipe -flto -fomit-frame-pointer -DNDEBUG" \
          EXTRA_CFLAGS="-arch ${{ matrix.arch }} -fPIC -D_DARWIN_C_SOURCE -DMAP_HUGETLB=0" make -j$(sysctl -n hw.ncpu)

          TAG="libttak-darwin-${{ matrix.arch }}"
          mkdir -p "dist/${TAG}/include" "dist/${TAG}/lib"
          cp -r include/* "dist/${TAG}/include/"
          cp lib/libttak.a "dist/${TAG}/lib/"
          cd dist && tar -czf "${TAG}.tar.gz" "${TAG}"
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-binary
          path: dist/*.tar.gz

  # 4. BSD Family: Comprehensive Matrix for 2026 Latest Release & Current
  build-bsd:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: freebsd
            version: '16.0-CURRENT'
          - os: freebsd
            version: '15.0'
          - os: freebsd
            version: '14.2'
          - os: freebsd
            version: '14.1'
          - os: openbsd
            version: '7.8'
          - os: netbsd
            version: '10.0'
    name: Build ${{ matrix.os }} (${{ matrix.version }})
    steps:
      - uses: actions/checkout@v4
      - name: Manual Build in VM
        uses: cross-platform-actions/action@v0.25.0
        with:
          operating_system: ${{ matrix.os }}
          version: ${{ matrix.version }}
          run: |
            # Robust package installation with non-interactive flags
            if [ "${{ matrix.os }}" = "freebsd" ]; then
              sudo pkg update
              sudo pkg install -y gmake gcc
              MAKE_CMD=gmake
            elif [ "${{ matrix.os }}" = "openbsd" ]; then
              sudo pkg_add -v gmake gcc
              MAKE_CMD=gmake
            else
              # NetBSD pkgin requires -y to be the first argument in some versions
              sudo pkgin -y install gmake gcc
              MAKE_CMD=gmake
            fi

            $MAKE_CMD clean
            # Inject native CC/AR and bypass Linux-only MAP_HUGETLB
            CC=gcc AR=ar \
            PERF_STACK_FLAGS="-O3 -pipe -fomit-frame-pointer -DNDEBUG" \
            EXTRA_CFLAGS="-fPIC -D__BSD_VISIBLE=1 -DMAP_HUGETLB=0" $MAKE_CMD -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)

            TAG="libttak-${{ matrix.os }}-${{ matrix.version }}-amd64"
            mkdir -p "dist/${TAG}/include" "dist/${TAG}/lib"
            cp -r include/* "dist/${TAG}/include/"
            cp lib/libttak.a "dist/${TAG}/lib/"
            cd dist && tar -czf "${TAG}.tar.gz" "${TAG}"
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-${{ matrix.version }}-binary
          path: dist/*.tar.gz

  # 5. Nightly Release Assembly
  release:
    needs: [standard-build, build-win-arm64, build-macos, build-bsd]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: nightly-${{ github.run_id }}
          name: LibTTAK Nightly Build (Full Support)
          files: dist/*.tar.gz
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
