@startuml
' libttak - Integrated System Map (Blueprints 01-12)
!theme plain
hide empty members
skinparam packageStyle rectangle
skinparam shadowing false
skinparam nodesep 100
skinparam ranksep 70
skinparam componentStyle uml2

title libttak: Integrated Architectural Map (01-12)

' --- APPLICATION LAYER ---
' Defined as a class with a stereotype for visual distinction
class "AliquotTracker (Example)" as App << (A,#E9FFE9) App >> #E9FFE9

' --- LOGIC LAYER (04, 08) ---
package "Specialized Logic [04, 08]" #E1F5FE {
    component Math [
        <b>Math Subsystem</b>
        (BigInt, NTT, Factor)
    ]
    component Trees [
        <b>Tree Structures</b>
        (B+, AST, MemTree)
    ]
}

' --- EXECUTION LAYER (01, 05) ---
package "Execution Runtime [01, 05]" #E8F5E9 {
    component Async [
        <b>Async Engine</b>
        (Scheduler, Futures)
    ]
    component Sched [
        <b>Priority Scheduling</b>
        (P-Queue, Nice)
    ]
}

' --- RESOURCE LAYER (02, 07, 09) ---
package "Resource Safety [02, 07, 09, 10, 11]" #FFF3E0 {
    component Safety [
        <b>Ownership & EBR</b>
        (Owner, Epoch, Shared)
    ]
    component DS [
        <b>Data Structures</b>
        (HT, RingBuffer, Pool)
    ]
    component Detach [
        <b>Detachable Memory</b>
        (Cache + Epoch Rows)
    ]
    component Arena [
        <b>Arena Memory</b>
        (Cache Rows, TTL, GC)
    ]
}

' --- FOUNDATION LAYER (03, 06) ---
package "System Foundation [03, 06]" #F5F5F5 {
    component Foundation [
        <b>Concurrency</b>
        (Thread Pool, Sync)
    ]
    component Utils [
        <b>Utilities & Services</b>
        (Timing, Log, Stats)
    ]
}

' --- DANGEROUS AREA ---
package "Dangerous Area" #FFEBEE {
    ' Uses the <<dangerous>> stereotype as requested
    component Bridge <<dangerous>> [
        <b>Context Bridge</b>
        (Expert Only)
    ]
}

package "IO & Net [12]" #E0F2F1 {
    component IOCore [
        <b>IO Core</b>
        (Guards, Buffers, Bits)
    ]
    component NetWire [
        <b>Network Runtime</b>
        (Endpoints, Views, Sessions)
    ]
}

' --- INTEGRATION FLOWS ---

' Application Entry Points
App -down-> Math : "computational logic"
App -down-> Async : "task orchestration"
App -down-> Safety : "resource boundaries"

' Logic Dependencies
Math -down-> Async : "parallel processing"
Math -down-> Safety : "resource tracking"
Trees -down-> DS : "internal containers"
Safety -down-> Trees : "uses MemTree for GC"

' Execution Dependencies
Async -down-> Sched : "task prioritization"
Async -down-> Foundation : "drives thread pool"
Sched -down-> Utils : "monitors timing"

' Resource & Foundation Dependencies
Safety -down-> Utils : "epoch management"
Safety -down-> DS : "metadata storage"
Safety -down-> Detach : "detachable policies"
Detach -down-> DS : "tracking rows"
Detach -down-> Foundation : "calloc/thread integration"
DS -down-> Foundation : "sync primitives"
Arena -down-> Safety : "owner-guarded rows"
Arena -down-> DS : "arena bookkeeping"
Arena -down-> Foundation : "thread-local slabs"
IOCore -down-> Safety : "owner + detachable arenas"
NetWire -down-> IOCore : "zero-copy recv/poll"
NetWire -down-> Async : "poll futures"

' Dangerous Bypass
Bridge .up.> Safety : "bypasses standard checks"

package "Embedded & Baremetal [13]" #FFF9C4 {
    component Buddy [
        <b>Buddy Allocator</b>
        (Embedded Pool)
    ]
    component NetPort [
        <b>Net Port</b>
        (Driver Ops Detect)
    ]
}

Buddy -down-> Safety : "ttak_mem_set_embedded_pool"
NetPort -down-> IOCore : "driver ops"
NetPort -down-> NetWire : "restart hooks"

legend bottom
  **Blueprint Scope:**
  [01] Async Layer | [02] Data Structures | [03] Memory & Threads | [04] Math Library
  [05] Priority Scheduling | [06] Utilities | [07] Safety & Ownership | [08] Tree Structures
  [09] Epoch Reclamation | [10] Detachable Memory | [11] Arena Memory | [12] IO & Net | [13] Embedded/Baremetal
endlegend

@enduml
