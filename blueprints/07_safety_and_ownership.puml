@startuml
!theme plain
hide empty members

skinparam class<<dangerous>> {
    BackgroundColor #ffe6e6
    BorderColor red
    FontColor #a00
}

package "Safety & Ownership (mem/)" {
    class ttak_owner_t {
        + id : uint32_t
        + resources : ttak_map_t*
        + functions : ttak_map_t*
        + lock : ttak_rwlock_t
        + policy_flags : uint32_t
        + creation_ts : uint64_t
        __
        + create(policy)
        + destroy()
        + register_func(name, func)
        + register_resource(name, data)
        + execute(func_name, resource_name, args)
    }

    class ttak_shared_t {
        + shared : void*
        + size : size_t
        + owners_mask : ttak_dynamic_mask_t
        + last_sync_ts : uint64_t[]
        + rwlock : ttak_rwlock_t
        + status : ttak_shared_status_t
        + level : ttak_shared_level_t
        + ts : uint64_t
        __
        + allocate(size, level)
        + add_owner(owner)
        + access(claimant, result)
        + sync_all(claimant, affected)
        + release()
    }

    ttak_shared_t o-- ttak_owner_t : "tracks via bitmap ID"

    enum ttak_owner_policy_t {
        TTAK_OWNER_SAFE_DEFAULT
        TTAK_OWNER_DENY_DANGEROUS_MEM
        TTAK_OWNER_DENY_THREADING
        TTAK_OWNER_STRICT_ISOLATION
    }

    class ttak_epoch_gc_t {
        + mem_tree : ttak_mem_tree_t*
        + current_epoch : uint64_t
        + last_cleanup_ts : uint64_t
        __
        + init()
        + destroy()
        + register(ptr, size)
        + rotate()
    }

    ttak_owner_t ..> ttak_owner_policy_t
    ttak_epoch_gc_t ..> ttak_mem_tree_t : uses

    class ttak_context_t <<dangerous>> {
        + first : ttak_owner_t*
        + second : ttak_owner_t*
        + shared_mem : void*
        + shared_size : size_t
        + ownership_side : int
        __
        + init(first, second, shared_mem, size, inherit)
        + run(request_side, cb, arg)
        + reassign(side)
    }

    ttak_owner_t -- ttak_context_t : "__TTAK_CTX_USE_FIRST__ / __TTAK_CTX_USE_SECOND__"

    note right of ttak_context_t
        NOT RECOMMENDED outside
        controlled lab setups.
        Only one side may mutate
        at a time; misuse can corrupt
        shared memory.
    end note
}
@enduml
